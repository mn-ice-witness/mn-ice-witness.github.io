# CONTEXT.md

This file is a **table of contents** for AI assistants. It tells you WHERE to find detailed information, and contains critical rules you must always follow.

## How This Works

1. **Read `~/.context.md` first** - Global coding preferences for all projects
2. **Read the Critical Rules below** - These apply to almost every task
3. **Scan the Quick Reference** to find which dev-docs to read for your task
4. **Read those specific dev-docs** before making changes

**The dev-docs are the source of truth for detailed procedures.** This file contains only rules that are critical enough to never miss.

---

## Project Overview

**MN ICE Files** documents civil rights incidents involving ICE/CBP in Minnesota during Operation Metro Surge (Dec 2025 - present). Mobile-first static site hosted on Cloudflare Pages.

---

## Critical Rules - Always Apply

These rules apply to almost every task. Do not skip them.

### Abbreviations
- **sm** = social media (see `dev-docs/social-media-listing-procedure.md`)

### Browser Testing
**Do NOT use Playwright** for browser testing unless explicitly asked. The user will test manually.

### Terminology
**"Entry" and "Incident" are synonyms.** The codebase uses both interchangeably. URLs use `/entry/`, code and docs say "incident" - they mean the same thing.

### Timestamps — MANDATORY SCRIPT USAGE
**NEVER type a timestamp manually.** LLMs ALWAYS fabricate plausible-looking times that are wrong.

**⚠️ REQUIRED WORKFLOW — Every time you set `created` or `last_updated`:**
```bash
./bin/timestamp.sh   # Run this FIRST, then copy-paste the output
```

This is not optional. Do not type `2026-01-22T12:00:00` or any other time from memory. Run the script, copy its output, paste it into the field. Every single time.

### incidents-summary.json
**NEVER edit `docs/data/incidents-summary.json` directly.** It is auto-generated by `scripts/generate_summary.py` and the pre-commit hook. Only edit the markdown incident files.

### Trustworthiness Ratings
**Use exactly ONE of these four values:**
- `high`
- `medium`
- `low`
- `unverified`

**NO compound values** like "medium-high" or "low-medium". Pick one.

### Incident Types
**Exactly 5 types exist:**
- `citizens` - U.S. citizens racially profiled or mistakenly targeted
- `observers` - People targeted for filming/observing/protesting ICE
- `immigrants` - Non-criminal immigrants detained
- `schools-hospitals` - Actions at/near schools or hospitals
- `response` - DHS/ICE official statements

Multiple types allowed via comma: `type: citizens, schools-hospitals`

### Unverified Incidents
Incidents with `trustworthiness: unverified` are **hidden from the main page** (both media gallery and list view). They appear only at `/unverified`, sorted by update date.

### SVG Icons
**NEVER inline SVG paths.** Always use the symbol/use pattern:

```html
<!-- WRONG -->
<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>

<!-- RIGHT -->
<svg width="16" height="16"><use href="#icon-play"/></svg>
```

Icons are defined in `docs/index.html`. See `dev-docs/ui-patterns.md` for the full list.

### Sources Must Have Links
**No link = not a source.** Every source in an incident file must link to a specific page about that incident. General homepages or profile pages don't count.

### Neutral Language
Use documentary tone. Let facts speak for themselves.

| Avoid | Use Instead |
|-------|-------------|
| raid, ransack | search |
| storm, invade | enter |
| kidnapped, snatched | detained, arrested |
| terrorize, brutalize | use force on |
| horrific, shocking | (describe facts instead) |
| exclusive, breaking | (omit) |

### Before Adding Incidents
**Always check `dev-docs/not_use.md`** for stories already evaluated and rejected. This prevents re-adding stories that don't fit the project scope.

### last_updated Field
**Only update for substantive story changes:**
- ✅ Court rulings, releases, status changes, new facts
- ❌ Adding more sources, formatting fixes, rating changes

### Updates Section Placement
**The `## Updates` section goes RIGHT AFTER THE TITLE, BEFORE SUMMARY** — never at the bottom. This is user-facing content readers see first. Hyperlink to the source, end with a period:
```markdown
# Incident Title

## Updates
- **Jan 22** - [KSTP investigation](URL) reveals new facts about the case.

## Summary
```

---

## Quick Reference: What Doc to Read

| If you're doing... | Read these dev-docs |
|-------------------|---------------------|
| **Adding a new incident** | `adding-incidents.md`, `incident-schema.md`, `not_use.md` |
| **Searching for new incidents** | `llm-search-procedure.md`, `research-sources.md`, `not_use.md` |
| **Modifying JavaScript** | `architecture.md` (JS module reference), `code-review-findings.md` |
| **Modifying CSS** | `architecture.md` (CSS structure section) |
| **URL/routing work** | `url-routing.md`, `single-page-navigation.md` |
| **Video player changes** | `media-controls.md` |
| **Adding icons or UI elements** | `ui-patterns.md` |
| **Processing media files** | `architecture.md` (media pipeline), `adding-video-audio.md` |
| **Testing on preview branch** | `preview-deployments.md` |
| **Understanding deployment** | `DEPLOYMENT.md` |
| **Refactoring code** | `refactoring-plan.md`, `code-review-findings.md` |
| **Social media posts** | `social-media-listing-procedure.md` |
| **Official DHS responses** | `researching-responses.md` |
| **Scaling concerns** | `scaling-strategy.md` |
| **Notable incidents feature** | `notable-incidents.md` |
| **Operation PARRIS context** | `operation-parris.md` |
| **Outreach/sharing** | `outreach-templates.md`, `contacts.md` |
| **OG image (social sharing)** | `og-image.md` |

---

## Code Structure

```
GIT_MN_ICE_FILES/
├── CONTEXT.md           # This file (TOC + critical rules)
├── dev-docs/            # ALL detailed documentation
├── bin/
│   ├── run-server.sh    # Local dev server (uses wrangler)
│   └── timestamp.sh     # Get current timestamp
├── scripts/
│   ├── generate_summary.py   # Creates incidents-summary.json
│   ├── generate_og_image.py  # Creates og-image.jpg collage
│   └── process_media.py      # Compresses raw_media → docs/media
├── raw_media/           # Source video/images (NEVER modified)
└── docs/                # Website content (deployed to Cloudflare)
    ├── index.html
    ├── css/style.css
    ├── js/              # See architecture.md for module details
    ├── functions/       # Cloudflare Functions for path URLs
    ├── incidents/       # ALL incident markdown files
    │   ├── 2025-12/
    │   └── 2026-01/
    ├── media/           # Processed video/images
    └── data/
        ├── incidents-summary.json  # Auto-generated, don't edit
        └── media-order.md          # Controls gallery ordering
```

---

## Dev-Docs Index

### Core Documentation
| Doc | Contents |
|-----|----------|
| `architecture.md` | System design, JS module reference, CSS structure, Python scripts, media pipeline |
| `incident-schema.md` | Frontmatter schema, body structure, source formatting |
| `adding-incidents.md` | Step-by-step guide, duplicate checking, trustworthiness criteria |

### Code Quality
| Doc | Contents |
|-----|----------|
| `code-review-findings.md` | File size analysis, dead code, duplication |
| `refactoring-plan.md` | Modular split, new file structure |

### URL & Navigation
| Doc | Contents |
|-----|----------|
| `url-routing.md` | Path-based URLs, Cloudflare Functions, OG tags |
| `single-page-navigation.md` | Hash navigation, section links |

### UI & Media
| Doc | Contents |
|-----|----------|
| `ui-patterns.md` | SVG icon pattern, available icons |
| `media-controls.md` | Video player, fullscreen |
| `adding-video-audio.md` | System audio capture |
| `media-candidates.md` | Videos to research |
| `og-image.md` | Social sharing image generation |

### Research & Content
| Doc | Contents |
|-----|----------|
| `research-sources.md` | News sources, social accounts |
| `researching-responses.md` | Finding DHS/ICE responses |
| `llm-search-procedure.md` | Daily search workflow |
| `not_use.md` | Rejected stories |
| `operation-parris.md` | Refugee detention context |
| `notable-incidents.md` | Notable flag feature |

### Operations & Deployment
| Doc | Contents |
|-----|----------|
| `DEPLOYMENT.md` | Cloudflare, DNS, deployment |
| `preview-deployments.md` | Testing branches |
| `scaling-strategy.md` | Data metrics, thresholds |
| `project-status.md` | Current state |

### Social & Outreach
| Doc | Contents |
|-----|----------|
| `contacts.md` | Official site URL, email, social media handles |
| `social-media-listing-procedure.md` | Daily posts |
| `outreach-templates.md` | Email templates |

### Reference
| Doc | Contents |
|-----|----------|
| `context-maintenance.md` | How to maintain this TOC system |
| `meta-not-use.md` | About page story exclusions |
| `social-posts-discussion.md` | Social posts ideas |
| `media-complications-ice-tactics.md` | Media coverage links |

---

## Development Commands

```bash
# Local dev server (includes Cloudflare Functions)
./bin/run-server.sh

# Simple server (no Functions)
./bin/run-server.sh --simple

# Process media files
python-main scripts/process_media.py

# Regenerate incidents JSON
python-main scripts/generate_summary.py

# Generate OG image from source folder
python-main scripts/generate_og_image.py docs/og-image

# Get current timestamp (ALWAYS use this)
./bin/timestamp.sh
```

---

## For LLMs: Maintaining This System

**When you create or significantly update a dev-doc:**

1. Check if CONTEXT.md's Quick Reference table needs updating
2. Check if the Dev-Docs Index needs a new entry or updated description
3. If the doc contains a rule that applies to many tasks, consider adding it to Critical Rules

**When the user asks to "reindex" or "update the TOC":**

Read `dev-docs/context-maintenance.md` for the full procedure.

**The goal:** An LLM reading only CONTEXT.md should:
- Know all critical rules that apply to most tasks
- Know exactly which dev-doc to read for any specific task
- Never miss important rules because they're buried in detail
