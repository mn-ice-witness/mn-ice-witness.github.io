# Architecture Overview

## Purpose

MN ICE Files is a static documentation website that tracks civil rights incidents involving ICE and CBP in Minnesota during Operation Metro Surge (December 2025 - present).

## Design Goals

1. **Factual & Credible** - Multiple sources, neutral language, include official responses
2. **Mobile-First** - Optimized for phones, works on desktop
3. **Fast Loading** - Static files, no backend, Cloudflare Pages hosting
4. **Easy to Update** - Add incidents via markdown files
5. **Immersive** - Videos, images, sources at fingertips

## Technology Stack

- **Hosting**: Cloudflare Pages (from `docs/` folder)
- **Frontend**: Vanilla HTML/CSS/JavaScript
- **Content**: Markdown files parsed client-side
- **Markdown Parser**: marked.js (CDN)
- **No build step required**

## File Structure

```
GIT_MN_ICE_FILES/
├── CONTEXT.md              # AI assistant instructions
├── dev-docs/               # Developer documentation (this folder)
│   ├── architecture.md     # This file
│   ├── incident-schema.md  # Markdown frontmatter schema
│   ├── adding-incidents.md # How to add new incidents
│   └── research-sources.md # Where to find/verify incidents
├── bin/
│   └── run-server.sh       # Local dev server script
└── docs/                   # Website content (ALL content here)
    ├── index.html          # Main entry point
    ├── css/style.css       # Styles
    ├── js/
    │   ├── app.js          # Main app, loads incidents
    │   ├── parser.js       # Parses markdown frontmatter
    │   └── lightbox.js     # Detail popup
    └── incidents/          # ALL incident markdown files (ONLY location!)
        ├── 2025-12/        # December 2025
        └── 2026-01/        # January 2026
```

**IMPORTANT:** All incident files MUST be in `docs/incidents/`. The website serves directly from the `docs/` folder.

## Data Flow

1. `index.html` loads, includes marked.js from CDN
2. `app.js` initializes, reads `incidentFiles` array
3. For each file, fetches markdown from `docs/incidents/` folder
4. `parser.js` extracts frontmatter (YAML between `---`) and body
5. Incidents grouped by `type` and rendered into sections
6. Click on card → `lightbox.js` opens detail view with full markdown

## Incident Types

| Type | Section | Color |
|------|---------|-------|
| `citizens` | U.S. Citizens Detained | Purple |
| `observers` | Bystanders & Observers | Blue |
| `immigrants` | Community Members | Cyan |
| `schools-hospitals` | Schools/Hospitals | Orange |
| `response` | Official Responses | Gray |

## Trustworthiness Ratings

| Level | Criteria | Color |
|-------|----------|-------|
| `high` | 3+ sources, video/photo evidence | Green |
| `medium` | 2 sources or official statements | Yellow |
| `low` | Single source or social media only | Red |
| `unverified` | Reported but not confirmed | Gray |

## Key Files

### `docs/js/app.js`
- Contains `incidentFiles` array listing all markdown files
- **Must be updated** when adding new incidents
- Handles rendering and filtering

### `docs/js/parser.js`
- Parses YAML frontmatter from markdown
- Extracts title, summary from body
- Provides formatting helpers

### `docs/js/lightbox.js`
- Modal popup for full incident details
- Embeds YouTube videos automatically
- Renders markdown to HTML

### `docs/data/incidents-summary.json`
- Auto-generated by `scripts/generate_summary.py`
- Contains all incident metadata for fast loading
- See [scaling-strategy.md](scaling-strategy.md) for data architecture decisions

## Media Pipeline

### Directory Structure
- `raw_media/` - **Original source files (NEVER modified)**
- `docs/media/` - Processed web-optimized files

### How It Works

1. **Source files are read-only**: The `raw_media/` folder contains original recordings. These files are NEVER touched or modified by the pipeline.

2. **Processing creates new files**: `scripts/process_media.py` reads from `raw_media/` and creates new compressed files in `docs/media/`.

3. **What the pipeline does**:
   - Crops 5px from all edges (removes screen recording artifacts)
   - Compresses video with H.264 (CRF 30)
   - Scales to max 720p height
   - Preserves audio if present in source
   - Optimizes for web streaming (faststart)

4. **Naming convention**:
   - Raw: `<incident-id>.raw.mov` (or .mp4, .png, etc.)
   - Output: `<incident-id>.mp4` (videos) or `<incident-id>.jpg` (images)

### Multi-Part Videos

For long videos split into multiple recordings, use the `:01`, `:02` suffix pattern:
- `2026-01-13-incident-name:01.raw.mov`
- `2026-01-13-incident-name:02.raw.mov`

The pipeline will:
1. Validate the sequence is complete (starts at :01, no gaps)
2. Concatenate the parts in order
3. Process the combined video
4. Output a single file: `2026-01-13-incident-name.mp4`

### Reprocessing Videos

**IMPORTANT: Never use `--force` unless explicitly asked.** The `--force` flag reprocesses ALL videos, which is slow and unnecessary.

To reprocess a single video:
1. Delete the output file in `docs/media/`
2. Run `python-main scripts/process_media.py` (without --force)

The pipeline only processes files where the output is missing or older than the source.

### Audio Note

If your source video has no audio, the processed video will have no audio. The pipeline preserves audio when present but cannot create it. When recording with macOS screen recording (Cmd+Shift+5), you must explicitly enable microphone/audio capture in the recording options.

### Local Media in Incidents

**Do NOT add "Local copy" links in incident markdown files.** The media displays automatically in the lightbox based on filename matching. Users can right-click the video to save it if needed. Example of what NOT to do:

```markdown
- **Video:** [Local copy](media/incident-id.mp4) - Description
```

## Related Documentation

- [scaling-strategy.md](scaling-strategy.md) - Data scaling decisions and future considerations
- [incident-schema.md](incident-schema.md) - Markdown frontmatter schema
- [adding-incidents.md](adding-incidents.md) - How to add new incidents
